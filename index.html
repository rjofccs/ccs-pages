<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="keywords" content="html5,css3,javascript,audio">
    <meta name="description" content="html5,css3,javascript,audio"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
	<meta name="version" content="1.0.0">

    <title>HTML5</title>
    <style>
        html,body,h1,h2,h3,h4,h5,h6,div,dl,dt,dd,ul,ol,li,p,blockquote,pre,hr,figure,table,caption,th,td,form,fieldset,legend,input,button,textarea,menu{margin:0;padding:0;-webkit-tap-highlight-color:rgba(0,0,0,0);word-wrap:break-word;font-size:inherit;line-height:inherit;overflow:visible}header,footer,section,article,aside,nav,address,figure,figcaption,menu,details{display:block}.f-cb{height:0}.f-cb:after{display:block;content:" ";height:0;visibility:hidden;clear:both}.f-ib{display:inline-block}.f-din{display:inline}.f-dn{display:none}.f-db{display:block}.f-fl{float:left}.f-fr{float:right}.f-fwn{font-weight:normal}.f-fwb{font-weight:bold}.f-tal{text-align:left}.f-tac{text-align:center}.f-tar{text-align:right}.f-oh{overflow:hidden;zoom:1;clear:both}.f-tdn{text-decoration:none!important}.f-vam,.f-vama *{vertical-align:middle}.f-wsn{word-wrap:normal;white-space:nowrap}.f-pre{overflow:hidden;text-align:left;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}.f-wwb{white-space:normal;word-wrap:break-word;word-break:break-all}.f-ti{overflow:hidden;text-indent:-30000px}.f-lhn{line-height:normal}.f-toe{overflow:hidden;word-wrap:normal!important;white-space:nowrap;text-overflow:ellipsis}.f-usn{-webkit-user-select:none;user-select:none}.f-bsb{-webkit-box-sizing:border-box;box-sizing:border-box}.f-cp{cursor:pointer}::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-button:vertical{display:none}::-webkit-scrollbar-track:vertical{background-color:transparent}::-webkit-scrollbar-track-piece{background-color:transparent}::-webkit-scrollbar-thumb:vertical{background-color:rgba(55,146,239,.3);border-radius:6px}::-webkit-scrollbar-thumb:vertical:hover,::-webkit-scrollbar-thumb:vertical:active{background-color:#2e86ef}html,body{width:100%;height:100%;background-color:#2e353b;overflow:hidden;font-family:"Microsoft Yahei","微软雅黑","Helvetica Neue","Hiragino Sans GB",Helvetica,Tahoma,sans-serif}.grid-music-container{width:720px;height:276px;padding:20px;position:relative;margin:80px auto;background-color:rgba(255,255,255,1);font-family:"Microsoft Yahei","微软雅黑","Helvetica Neue","Hiragino Sans GB",Helvetica,Tahoma,sans-serif;text-shadow:1px 0 0 rgba(255,255,255,.7)}.grid-music-container .m-music-play-wrap{height:125px;position:relative;padding-left:140px}.grid-music-container .u-cover{width:121px;height:121px;overflow:hidden;background:url(./music_icons.png) 0 0 no-repeat;position:absolute;top:0;left:0}.grid-music-container .u-cover img{display:block;width:100%;height:auto;max-height:100%;border-radius:50%}.grid-music-container .u-cover.play{-webkit-animation:Circle 10s linear infinite 0s forwards;animation:Circle 10s linear infinite 0s forwards}.grid-music-container .u-cover.paused{-webkit-animation-play-state:paused;animation-play-state:paused}@-webkit-keyframes Circle{from{-webkit-transform:rotate(0deg)}to{-webkit-transform:rotate(360deg)}}@keyframes Circle{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}.grid-music-container .m-now-info{height:100%}.grid-music-container .m-now-info h1{font-weight:normal}.grid-music-container .m-now-info h1 strong{font-size:18px;color:#111210;font-weight:normal}.grid-music-container .m-now-controls{padding:10px 0 0 0;position:relative}.grid-music-container .m-now-controls .u-control{display:inline-block;vertical-align:middle;font-size:0;overflow:hidden}.grid-music-container .m-now-controls .u-process{width:420px;height:4px;position:relative;background-color:#cecfd4;cursor:pointer}.grid-music-container .m-now-controls .u-process .buffer-process,.grid-music-container .m-now-controls .u-process .current-process{display:block;width:0;height:4px;position:absolute;top:0;left:0;background-color:#3792ef;z-index:1}.grid-music-container .m-now-controls .u-process .buffer-process{z-index:0;background-color:#c1c2c0}.grid-music-container .m-now-controls .u-time{margin-left:10px;font-size:12px;color:#585957}.grid-music-container .m-now-controls .u-volume{overflow:visible;text-align:center;position:relative;margin-left:20px}.grid-music-container .u-volume .volume-process{width:3px;height:50px;background:#cecfd4;position:absolute;top:-54px;left:6px;cursor:pointer;visibility:hidden}.grid-music-container .u-volume .volume-process.show{visibility:visible}.grid-music-container .u-volume .volume-process .volume-current,.grid-music-container .u-volume .volume-process .volume-event{display:inline-block;width:3px;height:50%;background-color:#3792ef;position:absolute;left:0;bottom:0;-webkit-transition:height .2s linear;transition:height .2s linear}.grid-music-container .u-volume .volume-process .volume-event{width:21px;left:-10px;background:0;height:100%;z-index:1}.grid-music-container .u-volume .volume-process .volume-bar{display:inline-block;width:8px;height:8px;border-radius:100%;background-color:#fff;border:1px solid #a8a9a7;position:absolute;left:-3px;bottom:50%;-webkit-transition:bottom .2s linear;transition:bottom .2s linear}
        .grid-music-container .u-volume .volume-process .volume-bar:hover,.grid-music-container .u-volume .volume-process .volume-bar:active{background-color:#f1f2f0}.grid-music-container .u-volume .volume-control{display:inline-block;width:18px;height:18px;background:url(./music_icons.png) -140px -80px no-repeat;cursor:pointer}.grid-music-container .u-volume .volume-control:hover{background-position:-158px -80px}.grid-music-container .u-volume .volume-control.muted{background-position:-140px -98px}.grid-music-container .u-volume .volume-control.muted:hover{background-position:-158px -98px}.grid-music-container .m-music-lyric-wrap{margin-left:135px;margin-right:25px;height:130px;border:1px solid rgba(255,255,255,.7);overflow-x:hidden;overflow-y:auto}.grid-music-container .m-music-lyric-wrap li{display:block;line-height:22px;padding:0 5px;cursor:pointer;color:#383937;font-size:14px}.grid-music-container .m-music-lyric-wrap li strong{font-size:16px;font-weight:normal}.grid-music-container .m-music-lyric-wrap li:hover,.grid-music-container .m-music-lyric-wrap li.current{background-color:rgba(255,255,255,.7);color:#3792ef}.grid-music-container .m-music-lyric-wrap li.current{background-color:transparent}.grid-music-container .m-play-controls{margin-top:10px}.grid-music-container .m-play-controls a{display:inline-block;vertical-align:middle}.grid-music-container .m-play-controls .u-play-btn{display:inline-block;width:30px;height:30px;margin-right:15px;cursor:pointer}.u-play-btn{background:url(./music_icons.png) -220px 0 no-repeat}.u-play-btn.prev,.u-play-btn.next{background-position:-220px 0}.u-play-btn.prev:hover,.u-play-btn.next:hover{background-position:-220px -36px}.u-play-btn.prev{-webkit-transform:rotate(-180deg);transform:rotate(-180deg)}.u-play-btn.play{background-position:-250px 0}.u-play-btn.play:hover{background-position:-250px -36px}.u-play-btn.paused{background-position:-280px 0}.u-play-btn.paused:hover{background-position:-280px -36px}.u-play-btn.mode{width:20px!important;height:18px!important;margin-right:10px!important}.u-play-btn.mode-list{background-position:-181px -98px;margin-left:65px}.u-play-btn.mode-list.current{background-position:-221px -98px}.u-play-btn.mode-random{background-position:-201px -80px}.u-play-btn.mode-random.current{background-position:-241px -80px}.u-play-btn.mode-single{background-position:-181px -80px}.u-play-btn.mode-single.current{background-position:-221px -80px}.grid-music-container .m-music-list-wrap{width:220px;height:100%;background-color:rgba(255,255,255,.7);position:absolute;right:-220px;top:0;border-left:1px solid #fff;overflow:hidden}.grid-music-container .m-music-list-wrap .inner{position:absolute;top:20px;left:20px;right:20px;bottom:20px;overflow-x:hidden;overflow-y:auto}.grid-music-container .m-music-list-wrap .inner ul{position:absolute;width:100%;top:0;left:0;overflow:hidden;-webkit-transition:all .3s;transition:all .3s}.grid-music-container .m-music-list-wrap ul li{display:block;line-height:30px;height:30px;overflow:hidden;text-align:center;font-size:13px;color:#666}.grid-music-container .m-music-list-wrap ul li.current{color:#2e86ef;font-size:14px;font-weight:bold}.grid-music-container .m-music-list-wrap ul li.eof{height:100%;line-height:250px;font-size:20px;color:#999}.m-music-list-wrap ul{padding:5px 10px}
    </style>
</head>
<body>


<div class="grid-music-container f-usn">
    <div class="m-music-play-wrap">
        <div class="u-cover"></div>
        <div class="m-now-info">
            <h1 class="u-music-title"><strong>标题</strong></h1>
            <div class="m-now-controls">
                <div class="u-control u-process">
                    <span class="buffer-process"></span>
                    <span class="current-process"></span>
                </div>
                <div class="u-control u-time">00:00/00:00</div>
                <div class="u-control u-volume">
                    <div class="volume-process" data-volume="0.50">
                        <span class="volume-current"></span>
                        <span class="volume-bar"></span>
                        <span class="volume-event"></span>
                    </div>
                    <a class="volume-control"></a>
                </div>
            </div>
            <!-- <div class="m-play-controls">
                <a class="u-play-btn prev" title="上一曲"></a>
                <a class="u-play-btn ctrl-play play" title="暂停"></a>
                <a class="u-play-btn next" title="下一曲"></a>
                <a class="u-play-btn mode mode-list current" title="列表循环"></a>
                <a class="u-play-btn mode mode-random" title="随机播放"></a>
                <a class="u-play-btn mode mode-single" title="单曲循环"></a>
            </div> -->
            <div class="m-play-controls">
                <a class="u-play-btn prev" title="上一句"></a>
                <a class="u-play-btn ctrl-play play" title="暂停"></a>
                <a class="u-play-btn next" title="下一句"></a>
            </div>
        </div>
    </div>
    <div class="f-cb">&nbsp;</div>
    <div class="m-music-lyric-wrap">
        <div class="inner">
            <ul class="js-music-lyric-content">
                <li class="eof">暂无歌词...</li>
            </ul>
        </div>
    </div>
    <div class="m-music-list-wrap"></div>
</div>

<script>
    !(function(win){
    /**
     * 添加样式
     */
    function addClass(element,className){
        if(hasClass(element,className) == false){
            element.className += ' '+className;
        }
    }
    /**
     * 是否包含样式
     */
    function hasClass(element,className){
        return !!element.className.match(new RegExp('(\\s|^)'+className+'(\\s|$)'));
    }
    /**
     * 移除样式
     */
    function removeClass(element,className){
        var currentClass = element.className;
        if(hasClass(element,className)){
            currentClass = currentClass.replace(new RegExp('(\\s|^)'+className+'(\\s|$)'),' ');
            currentClass = currentClass.replace(/(^\s*)|(\s*$)/g,'');
            element.className = currentClass;
        }
    }
    /**
     * 自动添加或删除样式（自动切换）
     */
    function toggleClass(element,className){
        if(hasClass(element,className)){
            removeClass(element,className);
        }else{
            addClass(element,className);
        }
    }
    /**
     * 返回元素节点
     */
    function $(element){
        return document.querySelector(element);
    }
    /**
     * 对象扩展
     */
    function extend(target,source){
        for(var p in source){
            if(source.hasOwnProperty(p)){
                target[p] = source[p];
            }
        }
        return target;
    }
    /**
     * 格式化时间
     */
    function calcTime(time){
        var hour,minute,second,timer = '';
        hour = String(parseInt(time/3600,10));
        minute = String(parseInt((time % 3600) / 60 ,10));
        second = String(parseInt(time % 60, 10));
        if(hour != '0'){
            if(hour.length == 1) hour = '0' + hour;
            timer += (hour + ':');
        }
        if(minute.length == 1) minute = '0' + minute;
        timer += (minute + ':');
        if(second.length == 1) second = '0' + second;
        timer += second;
        return timer;
    }
    /**
     * 简单Ajax请求
     */
    function ajax(url,callback){
        if(!url) return false;
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                var status = xhr.status;
                if((status >= 200 && status < 300) || status == 304){
                    (callback && typeof callback == "function") && callback(xhr.responseText);
                    return true;
                }else{
                    return new Error("ajax请求失败");
                }
            }
        };
        xhr.open("GET", url,true);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.send();
        return true;
    }
    var bufferTimer = null;

    /**
     * 构造函数
     */
    function Music163(config){
        var defaults = this.config;
        this.config = extend(defaults,config);
        this.musicList = this.config.musicList || [];
        this.musicLength = this.musicList.length;
        if(!this.musicLength || !$('body')){
            this.musicDom.listWrap.innerHTML = '<p>暂无播放记录...</p>';
        }
        this.audioDom = null; //audio对象
        this.init();
    }
    Music163.prototype = {
        config : {
            musicList : [],    //播放列表
            defaultVolume :.7,  //初始化音量 0 - 1.0 之间
            defaultIndex  : 0,  //初始化播放索引
            defaultMode : 1,     //播放模式
            callback    : function(obj){}  //回调函数，返回当前播放媒体信息
        },
        /**
         * 创建播放列表
         */
        createListDom : function(){
            var i = 0, ul = '<ul>';
            for(i;i<this.musicLength;i++){
                ul += '<li class="f-toe"><strong>'+this.musicList[i]['title']+'</strong></li>';
            }
            ul += '</ul>';
            this.musicDom.listWrap.innerHTML = ul;
        },
        /**
         * 缓冲加载
         */
        setBuffer : function(audio,bufferDom){
            var w = bufferDom.parentNode.offsetWidth;
            bufferTimer = setInterval(function(){
                var buffer = audio.buffered.length;
                if(buffer > 0 && audio.buffered != undefined){
                    var bufferWidth =  (audio.buffered.end(buffer-1) / audio.duration) * w;
                    bufferDom.style.width = bufferWidth + 'px';
                    if(Math.abs(audio.duration - audio.buffered.end(buffer-1)) <1){
                        bufferDom.style.width = w + 'px';
                        clearInterval(bufferTimer);
                    }
                }
            },1000);
        },
        /**
         * 重载播放器
         */
        resetPlayer : function(idx){
            (idx >= (this.musicLength-1)) && (idx = (this.musicLength-1));
            (idx <= 0) && (idx = 0);
            this.currentMusic = idx;
            var nowMusic = this.musicList[idx],  //获取当前的播放音乐信息
                me = this;
            //过渡函数，用于事件监听和移除，暂时性的解决通过addEventListener添加的事件传递匿名函数无法移除的问题
            var tempBuffer = function(){
                return me.setBuffer(this,me.musicDom.bufferProcess);
            };
            //在canplay事件监听前移除之前的监听
            this.audioDom.removeEventListener('canplay',tempBuffer,false);
            clearInterval(bufferTimer);
            //样式重置（元素属性重新设置）
            this.musicDom.bufferProcess.style.width = 0+'px';
            this.musicDom.curProcess.style.width = 0 + 'px';
            this.audioDom.src = nowMusic.src;
            //this.musicDom.cover.innerHTML = '<img src="'+nowMusic.cover+'" title="'+nowMusic.title + '">';
            this.musicDom.title.innerHTML = '<strong>'+nowMusic.title+'</strong>';
            me.musicDom["lyricWrap"].innerHTML = '<li class="eof">正在加载歌词...</li>';
            me.musicDom["lyricWrap"].style.marginTop = 0 + "px";
            me.musicDom["lyricWrap"].scrollTop = 0;
            this.lazyLyric(idx);
            //设置播放列表选中
            var playlist = document.querySelectorAll('.m-music-list-wrap li'), i = 0;
            for(i; i< this.musicLength;i++){
                if(i == idx){
                    addClass(playlist[i],'current');
                }else{
                    removeClass(playlist[i],'current');
                }
            }
            //可以播放时，设置缓冲区，重新监听 canplay  PS：当音频能够播放时，才会触发该事件
            this.audioDom.addEventListener('canplay',tempBuffer,false);
            this.pause();
            var _callback = nowMusic;
            _callback.index = idx;
            typeof this.config.callback == "function" && this.config.callback(_callback);  //将当前播放信息回调
        },
        /**
         * 音量设置
         */
        setVolume : function(volume){
            var v = this.musicDom.volume,
                h = v.volumeEventer.offsetHeight || 50;  //隐藏元素的高度不好获取，这里设置visible来实现同样的效果
            if(volume <= 0) volume = 0;
            if(volume >= 1) volume = 1;
            this.audioDom.volume = volume;
            var currentHeight = h * volume;
            v.volumeCurrent.style.height = currentHeight + 'px';
            v.volumeCtrlBar.style.bottom = currentHeight + 'px';
            v.volumeProcess.setAttribute('data-volume',volume);
            if(volume == 0){
                //静音
                addClass(v.volumeControl,'muted');
                this.audioDom.muted = true;
            }else{
                removeClass(v.volumeControl,'muted');
                this.audioDom.muted = false;
            }
        },
        /**
         * 初始化播放器
         */
        initPlay : function(){
            var idx = this.config.defaultIndex;
            // if(this.playMode == 2){ //随机播放
            //     idx = this.getRandomIndex();
            // }
            this.setVolume(this.config.defaultVolume);
            this.audioDom.load();
            this.resetPlayer(idx);
        },
        /**
         * 播放
         */
        play : function(){
            var ctrl = this.musicDom.button.ctrl;
            this.audioDom.play();
            removeClass(ctrl,'paused');
            addClass(ctrl,'play');
            ctrl.setAttribute('title','暂停');
            removeClass(this.musicDom.cover,'paused');
            addClass(this.musicDom.cover,'play');
        },
        setPos : function(sec){
            this.audioDom.currentTime = sec;
        },
        /**
         * 暂停
         */
        pause : function(){
            var ctrl = this.musicDom.button.ctrl;
            this.audioDom.pause();
            removeClass(ctrl,'play');
            addClass(ctrl,'paused');
            ctrl.setAttribute('title','播放');
            removeClass(this.musicDom.cover,'play');
            addClass(this.musicDom.cover,'paused');
        },
        /**
         * 获取不包含当前索引的随机索引
         */
        // getRandomIndex : function(){
        //     var idx = this.currentMusic,len  = this.musicLength, i = 0, temp = [];
        //     //应该在不包括当前的列表中播放
        //     for(i;i<len;i++){
        //         if(i != idx){
        //             temp.push(i);
        //         }
        //     }
        //     var random = parseInt(Math.random() * temp.length);
        //     return temp[random];
        // },
        /**
         * 通过播放模式加载歌曲并播放
         */
        // playByMode : function(type){
        //     var modes = this.playMode,
        //         idx  = this.currentMusic,
        //         len  = this.musicLength,
        //         index = idx;
        //     if(modes == 1){  //列表
        //         if(type == 'prev'){
        //             index = ((idx <= len - 1) && (idx > 0)) ? (idx-1) : (len-1);
        //         }else if(type == 'next' || type == 'ended'){  //增加一个ended区别单曲循环
        //             index = (idx >= len - 1) ? 0 : (idx+1);
        //         }
        //     }else if(modes == 2){ //随机
        //         index = this.getRandomIndex();  //无论上下曲，随机获取一个不是当前播放的索引
        //     }else if(modes == 3){ //单曲
        //         if(type == 'prev'){
        //             index = ((idx <= len - 1) && (idx > 0)) ? (idx-1) : (len-1);
        //         }else if(type == 'next'){
        //             index = (idx >= len - 1) ? 0 : (idx+1);
        //         }else{
        //             index = idx;
        //         }
        //     }
        //     this.resetPlayer(index);
        // },
        /**
         * 一些操作
         */
        action : function(){
            var  me = this, v = this.musicDom.volume, btn = this.musicDom.button;
            var  curTime;
            var  curMusic = this.currentMusic;
            var  timesCache = this.timesCache;
            //监听timeupdate，设置进度，PS:播放过程中，当前播放位置改变时，会触发该事件
            this.audioDom.addEventListener('timeupdate',function(){
                var audio = this;
                if(!isNaN(audio.duration)){
                    var surplusTime = calcTime(audio.currentTime),
                        totalTime   = calcTime(audio.duration);
                    var currentProcess = (audio.currentTime / audio.duration) * (me.musicDom.bufferProcess.parentNode.offsetWidth);
                    //当前播放时间/总时间 = 播放百分比
                    //播放百分比 * 进度条长度 = 当前播放进度
                    me.musicDom.time.innerHTML = ''+surplusTime+'/'+totalTime+'';
                    me.musicDom.curProcess.style.width = currentProcess + 'px';
                    //歌词滚动
                    //设置歌词
                    curTime = parseInt(audio.currentTime*1e3);
                    var lyrics  = me.musicDom["lyricWrap"].querySelectorAll(".u-lyric"),
                        sizes   = lyrics.length,
                        i       = 0;
                    if(sizes > 1){
                        for(;i < sizes ; i++){
                            var lyl = lyrics[i];
                            if(lyl){
                                var _time = parseFloat(lyl.getAttribute("data-time"));
                                if(curTime >= _time){
                                    var top = (i-1) * 22; //22是每个LI的高度
                                    me.musicDom["lyricWrap"].style.marginTop = -top + "px";
                                    //移除之前的current，想念Jquery的siblings
                                    for(var j = 0 ; j < sizes ;j++){
                                        lyrics[j] && removeClass(lyrics[j],"current");
                                    }
                                    addClass(lyl,"current"); //给当前行加上current                   
                                }
                            }
                        }
                    }
                }
            },false);
            //监听 播放结束，PS:当音频播放完毕或者播放结束时会触发ended事件
            this.audioDom.addEventListener('ended',function(){
                // me.playByMode('ended');
            },false);
            //显示隐藏音量控制器，静音等操作
            v.volumeControl.addEventListener('click',function(event){
                event = event || window.event;
                event.stopPropagation();
                if(hasClass(v.volumeProcess,'show')){
                    toggleClass(this,'muted');
                    hasClass(this,'muted') ? (me.audioDom.muted = true) : (me.audioDom.muted = false);
                }else{
                    addClass(v.volumeProcess,'show');  //显示
                }
            },false);
            //区域外点击隐藏控制器
            document.addEventListener('click',function(event){
                event = event || window.event;
                event.stopPropagation();
                var target = event.target || event.srcElement;
                if((target.parentNode !== v.volumeProcess) && target.parentNode !== $('.grid-music-container .u-volume')){
                    //当触发事件的元素不在音量元素范围里时关闭
                    removeClass(v.volumeProcess,'show');
                }
            },false);
            //音量控制
            v.volumeEventer.addEventListener('click',function(event){
                event = event || window.event;
                event.stopPropagation();
                var h = this.offsetHeight,
                    y = event.offsetY,  //获取距离父级相对位置
                    volume = (h-y) / h;
                me.setVolume(volume);
            },false);
            //点击列表切歌
            var playlist = document.querySelectorAll('.m-music-list-wrap li'), i = 0;
            for(i; i< this.musicLength;i++){
                !(function(i){
                    playlist[i].addEventListener('dblclick',function(){
                        me.resetPlayer(i);
                        me.play();
                    },false);
                    playlist[i].addEventListener('click',function(){
                        me.resetPlayer(i);
                    },false);
                }(i));
            }
            //暂停/播放
            btn.ctrl.addEventListener('click',function(){
                if(hasClass(this,'play')){
                    me.pause();
                }else{
                    me.play();
                }
            },false);
            //上一曲
            btn.prev.addEventListener('click',function(){
                // me.playByMode('prev');
                var cm = timesCache[curMusic];
                var i = 0;
                for(i;i<cm.length;i++){
                    if(cm[i]<=curTime&&curTime<=cm[i+1]){
                        console.log(cm[i], cm[i-1]);
                        me.setPos((cm[i-1] * 1.0 / 1000).toFixed(2));
                        break;
                    }
                }
            },false);
            //下一曲
            btn.next.addEventListener('click',function(){
                // me.playByMode('next');
                var cm = timesCache[curMusic];
                var i = 0;
                for(i;i<cm.length;i++){
                    if(cm[i]<=curTime&&curTime<=cm[i+1]){
                        console.log(cm[i], cm[i+1]);
                        me.setPos((cm[i+1] * 1.0 / 1000).toFixed(2));
                        break;
                    }
                }
            },false);
            //模式选择
            //列表循环
            // btn.listCircular.addEventListener('click',function(){
            //     addClass(this,'current');
            //     removeClass(btn.singleCircular,'current');
            //     removeClass(btn.randomPlay,'current');
            //     me.playMode = 1;
            // });
            //随机播放
            // btn.randomPlay.addEventListener('click',function(){
            //     addClass(this,'current');
            //     removeClass(btn.singleCircular,'current');
            //     removeClass(btn.listCircular,'current');
            //     me.playMode = 2;
            // });
            //单曲循环
            // btn.singleCircular.addEventListener('click',function(){
            //     addClass(this,'current');
            //     removeClass(btn.listCircular,'current');
            //     removeClass(btn.randomPlay,'current');
            //     me.playMode = 3;
            // });
            //拖动进度条，快进
            var $progress = this.musicDom["curProcess"].parentNode;
            $progress.addEventListener("click",function(e){
                e = e || window.event;
                var left = this.getBoundingClientRect().left,width = this.offsetWidth;
                var progressX = Math.min(width,Math.abs(e.clientX - left)); //防止超出范围
                if(me.audioDom.currentTime && me.audioDom.duration){
                    me.audioDom.currentTime = parseInt((progressX / width) * (me.audioDom.duration)); //重新设置播放进度
                    me.play();
                }    
            });
        },
        /**
         * 加载歌词
         * 目前只支持UTF8编码
         * 不支持跨域，如果要跨域则自行更改ajax为jsonp
         */
        lazyLyric : function (index) {
            if(this.lyricCache[index]){
                this.renderLyric(this.lyricCache[index]);
            }else{
                var url = this.musicList[index]["lyric"], me = this;
                if(url){
                    ajax(url, function (data) {
                        me.lyricCache[index] = data ? data : null;
                        var times = me.renderLyric(data);
                        me.timesCache[index] = times;
                    });
                }else{
                    this.lyricCache[index] = null;
                    me.renderLyric(null);
                }
            }
        },
        /**
         * 解析歌词
         * 歌词按时间分组并存储到数组
         * [{content: "车站 (Live) - 李健↵",time: 800}...]
         */
        parseLyric : function (lyric) {
            if(!lyric) return lyric;
            var result = [];
            var cArr = lyric.split("[");
            cArr.shift();
            for (var i = 0; i < cArr.length; i++) {
                var o = cArr[i].split("]");
                if (o.length >= 2 && o[1] != "") {
                    var tArr = o[0].split(":"), t = 0;
                    if (tArr.length >= 2) {
                        var mtArr = tArr[0].split(""), mt = 0;
                        for (var k = 0; k < mtArr.length; k++) {
                            if (Number(mtArr[k]) > 0) {
                                mt += mtArr[k] * Math.pow(10, mtArr.length - k - 1);
                            }
                        }
                        t += mt * 60;
                        var stArr = tArr[1].split("."), intStArr = stArr[0].split(""), st = 0;
                        for (var j = 0; j < intStArr.length; j++) {
                            if (Number(intStArr[j]) > 0) {
                                st += intStArr[j] * Math.pow(10, intStArr.length - j - 1);
                            }
                        }
                        t += Number(st + "." + stArr[1]);
                    }
                    if(t && typeof t == "number"){
                        result.push({time : parseInt(t * 1e3), content : o[1]});
                    }
                }
            }
            return result;
        },
        /**
         * 渲染歌词
         */
        renderLyric : function (lyric) {
            lyric = this.parseLyric(lyric);

            var me = this, dom = me.musicDom["lyricWrap"], tpl = "",len, i = 0;
            var times = [];
            len = lyric ? lyric.length : 0;
            if(lyric && len){
                for( i ; i < len ; i ++){
                    var data = lyric[i];
                    var time = data["time"], text = data["content"].trim();
                    text = text ? text : '--- smusic ---';
                    tpl += '<li class="u-lyric f-toe" data-time="'+time+'">'+text+'</li>';
                    times.push(time);
                }
                tpl && (tpl += '<li class="u-lyric">www.net</li>');
            }else{
                tpl = '<li class="eof">暂无歌词...</li>';
            }
            dom.style.marginTop = 0 + "px";
            dom.screenTop = 0;
            dom.innerHTML = tpl;
            return times;
        },
        /**
         * 初始化播放器
         */
        init : function(){
            //缓存DOM结构
            this.musicDom = {
                music : $('.grid-music-container'),
                cover : $('.grid-music-container .u-cover'),
                title : $('.grid-music-container .u-music-title'),
                curProcess : $('.grid-music-container .current-process'),
                bufferProcess : $('.grid-music-container .buffer-process'),
                time : $('.grid-music-container .u-time'),
                listWrap : $('.grid-music-container .m-music-list-wrap'),
                lyricWrap : $('.grid-music-container .js-music-lyric-content'), //歌词区域
                volume   : {
                    volumeProcess : $('.grid-music-container .volume-process'),
                    volumeCurrent : $('.grid-music-container .volume-current'),
                    volumeCtrlBar : $('.grid-music-container .volume-bar'),
                    volumeEventer : $('.grid-music-container .volume-event'),  //主要作用于绑定事件，扩大了音量的触发范围
                    volumeControl : $('.grid-music-container .volume-control')
                },
                button  : {
                    ctrl : $('.grid-music-container .ctrl-play'),
                    prev : $('.grid-music-container .prev'),
                    next : $('.grid-music-container .next')
                    // listCircular : $('.grid-music-container .mode-list'), //列表循环
                    // randomPlay   : $('.grid-music-container .mode-random'), //随机循环
                    // singleCircular : $('.grid-music-container .mode-single') //单曲循环
                }
            };
            this.currentMusic = this.config.defaultIndex || 0;
            this.playMode = this.config.defaultMode || 1; //播放模式，默认列表循环
            this.lyricCache = {}; //缓存已加载的歌词文件
            this.timesCache = {}; //缓存已加载的歌词文件
            this.audioDom = document.createElement('audio');
            this.createListDom();
            this.initPlay();
            this.action();
        }
    };
    win = win || window;
    //重新封装，实例化后返回一个全局对象
    win.SMusic = function(options){
        return new Music163(options);
    };
})(window);
</script>

<script>
    var musicList = [
        {
            title: 'Memories Approaching Nirvana',
            src: 'us-high-court-reviews-race-consideration-in-college-admission.mp3',
            lyric: "us-high-court-reviews-race-consideration-in-college-admission.lrc"
        }
    ];
    new SMusic({
        musicList: musicList,
        // defaultMode: 1,
        callback: function (obj) {
            // console.log(obj);
        }
    });
</script>
</body>
</html>
